---
title: "Activity_2_Happiness"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(car)
library(MASS)
library(corrplot)
library(reshape2)
library(faraway)
library(caret)
library(lmtest)
```
## 1. Import and clean data 
```{r}
data <- read.csv("world-happiness-report-with-regions.csv", header = TRUE, sep = ",")
attach(data)
str(data)
head(data)
```

```{r}
missing_values <- sapply(data, function(x) sum(is.na(x)))
print(missing_values)
```

```{r}
data_clean <- data %>%
  group_by(Country) %>%
  mutate(across(where(is.numeric), ~ ifelse(is.na(.), mean(., na.rm = TRUE), .)))
data_clean <- unique(data_clean)
print(data_clean)
# 1708 / 19
```

```{r}
str(data_clean)
attach(data_clean)
```
```{r}
ggplot(data, aes(y = Freedom.to.make.life.choices)) +
  geom_boxplot(fill = "lightblue", color = "black") +
  labs(title = "...", y = "Freedom")

ggplot(data, aes(y = Life.Ladder)) +
  geom_boxplot(fill = "lightblue", color = "black") +
  labs(title = "...", y = "Ladder")


ggplot(data, aes(y = Positive.affect)) +
  geom_boxplot(fill = "lightblue", color = "black") +
  labs(title = "...", y = "Positive")

ggplot(data, aes(y = Negative.affect)) +
  geom_boxplot(fill = "lightblue", color = "black") +
  labs(title = "...", y = "Negative")

ggplot(data, aes(y = Generosity)) +
  geom_boxplot(fill = "lightblue", color = "black") +
  labs(title = "...", y = "Generosity")
ggplot(data, aes(y = Log.GDP.per.capita)) +
  geom_boxplot(fill = "lightblue", color = "black") +
  labs(title = "...", y = "Log GDP")

ggplot(data, aes(y = Social.support)) +
  geom_boxplot(fill = "lightblue", color = "black") +
  labs(title = "...", y = "Social support")

ggplot(data, aes(y = Healthy.life.expectancy.at.birth)) +
  geom_boxplot(fill = "lightblue", color = "black") +
  labs(title = "...", y = "Healthy life expectancy")
ggplot(data, aes(y = Perceptions.of.corruption)) +
  geom_boxplot(fill = "lightblue", color = "black") +
  labs(title = "...", y = "Perceptions of corruption")
```
```{r}
model <- lm(Life.Ladder ~ . -Country - Region, data = data_clean)

# Calculate Cook's distance
cooksd <- cooks.distance(model)

# Plot Cook's distance
plot(cooksd, pch="*", cex=2, main="Cook's distance", ylab="Cook's distance")
abline(h = 4/length(cooksd), col="red")  # Add a horizontal line at 4/n
text(x=1:length(cooksd)+1, y=cooksd, labels=ifelse(cooksd>4/length(cooksd),names(cooksd),""), col="red")

# Identify influential points
influential <- as.numeric(names(cooksd)[(cooksd > 4/length(cooksd))])

# Optionally, remove influential points from the dataset
data_clean <- data_clean[-influential, ]

```
```{r}
dim(data_clean)
```

```{r}
pie(table(year))
barplot(table(year))
# More countries take survey from 2006
```

```{r}
hist(data_clean$Log.GDP.per.capita, breaks = 20)
# Left-skewed distribution, many countries have average log GDP per capita
```

```{r}
hist(Social.support, breaks = 30)
# average of national responses on the question... 
# left-skewed, most responses were yes
# highest values 0.9
```

```{r}
hist(Freedom.to.make.life.choices, breaks = 30)
# average of national responses on the question... 
# left-skewed, most responses were yes
```

```{r}
hist(Healthy.life.expectancy.at.birth, breaks = 40)
# average life expectancy
# most people expect their age between 65-68 or 71-72
```
```{r}
hist(Generosity, breaks = 30)
# Residual of regressing national average of response to the question...
# residual -> negative is possible
# most people say no
```
```{r}
hist(Perceptions.of.corruption, breaks = 30)
# average of national responses on the 2 questions on corruption
# most people response 2 yes
```
```{r}
hist(Positive.affect, breaks = 30)
# average of 3 positive affect measures
# left-skewed
```
```{r}
hist(Negative.affect, breaks = 30)
# average of 3 negative effects per country
# right-skewed
# most people feels little negative effect
```
```{r}
hist(Life.Ladder, breaks = 30)
# the ladder score (happiness score), from 0 to 10
# looks approximately normal
```

```{r}
plot(Life.Ladder ~ Negative.affect, data = data_clean)
# Lots of outliers in the Negative.affect plot
# Life.Ladder plot looks normal
# The relationship between the two variables is not clear
# correlation: -0.286
cor(Life.Ladder, Negative.affect)
```

```{r}
plot(Life.Ladder ~ Positive.affect, data = data_clean)
cor(Life.Ladder, Positive.affect)
# Relationship: positive relationship between the two variables, but not quite clear (0.562)
```

```{r}
plot(Life.Ladder ~ Log.GDP.per.capita, data = data_clean)
cor(Life.Ladder, Log.GDP.per.capita)
# Relationship: positive relationship between the two variables, obvious positive relationship
```

```{r}
plot(Life.Ladder ~ Healthy.life.expectancy.at.birth, data = data_clean)
cor(Life.Ladder, Healthy.life.expectancy.at.birth)
# Relationship: positive relationship between the two variables, clear relationship
```

```{r}
plot(Life.Ladder ~ Social.support, data = data_clean)
cor(Life.Ladder, Social.support)
# Relationship: positive relationship between the two variables, clear relationship
```

```{r}
plot(Life.Ladder ~ Freedom.to.make.life.choices, data = data_clean)
cor(Life.Ladder, Freedom.to.make.life.choices)
# Relationship: seems positive, but not quite clear
```

```{r}
plot(Life.Ladder ~ Generosity, data = data_clean)
cor(Life.Ladder, Generosity)
# Relationship: no relationship
```

```{r}
plot(Life.Ladder ~ Perceptions.of.corruption, data = data_clean)
cor(Life.Ladder, Perceptions.of.corruption)
# Relationship: negative relationship, but not clear
```

```{r}
boxplot(Life.Ladder ~ year, data = data_clean)
# Shows a (quite) consistent ladder score over years
```
```{r}
boxplot(Life.Ladder ~ Region, data = data_clean)
```

```{r}
data_clean <- as.data.frame(data_clean)
data_clean$Region <- as.factor(data_clean$Region)

# Create dummy variables
dummy_vars <- model.matrix(~ Region, data = data_clean)

# Remove the intercept column
dummy_vars <- dummy_vars[, -1]

# Combine the dummy variables with the original data frame
data_clean <- cbind(data_clean, dummy_vars)

data_clean <- dplyr::select(data_clean, -Country)
data_clean <- dplyr::select(data_clean, -Region)
# Display the first few rows of the data frame with dummy variables
head(data_clean)
```

```{r}
set.seed(1)
sample_size <- floor(0.8 * nrow(data_clean))
train_indices <- sample(seq_len(nrow(data_clean)), size = sample_size)
data_train <- data_clean[train_indices, ]
data_test <- data_clean[-train_indices, ]
detach(data_clean)
attach(data_train)
```

```{r}
model = lm(Life.Ladder ~ . , data = data_train)
summary(model)
```

```{r}
vif_values = vif(model)
max_vif <- max(vif_values)
while (max_vif > 10) {
  max_vif_var <- names(vif_values[vif_values == max_vif])
  data_train <- data_train[ , !(names(data_train) %in% max_vif_var)]
  model <- lm(Life.Ladder ~ . , data = data_train)
  vif_values <- vif(model)
  max_vif <- max(vif_values)
}
```


```{r}
model <- lm(Life.Ladder ~ . , data = data_train)
vif(model)
print(max(vif(model)))
```

```{r}
# Test the collinearity of the healthy life variable
test <- lm(Healthy.life.expectancy.at.birth ~ . - Life.Ladder, data = data_train)
summary(test)
# R^2 = 0.85 -> high collinearity -> remove the variable
```
```{r}
model <- lm(Life.Ladder ~ . - Healthy.life.expectancy.at.birth, data = data_train)
summary(model)
vif(model)
```
```{r}
modFull = lm(Life.Ladder ~ . - Healthy.life.expectancy.at.birth, data = data_train)
modZero = lm(Life.Ladder ~ 1, data = data_train)
modInter = lm(Life.Ladder~ Log.GDP.per.capita + Social.support + Freedom.to.make.life.choices + Generosity
+ Perceptions.of.corruption + Positive.affect + Negative.affect, data = data_train)
```

```{r}
model2 = MASS::stepAIC(modInter, direction = "both", scope = list(lower = modZero, upper = modFull), k = 2)
summary(model2)
```

```{r}
model3 = MASS::stepAIC(modInter, direction = "both", scope = list(lower = modZero, upper = modFull), k = log(nrow(data_train)))
summary(model3)
```

```{r}
anova(model2, model3)
# Since P-value < 0.05, we reject H0 and conclude that the model with more variables is better
# However, it's not worth to keep the model with more variables but less than 1% improvement in R^2
# We will keep the model with fewer variables
```

```{r}
shapiro.test(residuals(model3))
par(mfrow=c(1,2))

hist_residuals <- residuals(model3)
hist(hist_residuals, main = "Residuals Histogram", xlab = "Residuals", breaks = 100, probability = TRUE)

mean_residuals <- mean(hist_residuals)
sd_residuals <- sd(hist_residuals)
curve(dnorm(x, mean = mean_residuals, sd = sd_residuals), col = "red", add = TRUE)

qqnorm(hist_residuals, main = "Q-Q Plot of Residuals")
qqline(hist_residuals, col = "red")
```

```{r}
bp_test <- bptest(model3)
print(bp_test)
# Fail BP test, meaning that the variance is not constant -> Apply Box-cox transformation
```

```{r}
# Life.Ladder ~ Log.GDP.per.capita + Social.support + Freedom.to.make.life.choices + 
#    Generosity + Perceptions.of.corruption + Positive.affect + 
#    `RegionLatin America and Caribbean` + `RegionSoutheast Asia` + 
#    `RegionSub-Saharan Africa` + `RegionWestern Europe` + `RegionNorth America and ANZ`
model_cox = lm(Life.Ladder~ Log.GDP.per.capita + Social.support + Freedom.to.make.life.choices + 
    Generosity + Perceptions.of.corruption + Positive.affect + `RegionSoutheast Asia` + `RegionLatin America and Caribbean`  , data = data_train)
summary(model_cox)
boxcox_result <- boxcox(model_cox, plotit = TRUE)
lambda <- boxcox_result$x
log_likelihood <- boxcox_result$y
best_lambda <- lambda[which.max(log_likelihood)]

# Print the best lambda
print(best_lambda)
```

```{r}
best_lambda = 1.8
model_cox = lm(((((Life.Ladder)^best_lambda) - 1)/best_lambda) ~ Log.GDP.per.capita + Social.support + Freedom.to.make.life.choices + Generosity + Perceptions.of.corruption + Positive.affect + `RegionSoutheast Asia` + `RegionLatin America and Caribbean`  , data = data_train)
summary(model_cox)
```

```{r}
shapiro.test(residuals(model_cox))
bp_test <- bptest(model_cox)
print(bp_test)
```