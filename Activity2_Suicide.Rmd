---
title: "Activity2_Suicide"
output: html_document
date: "2024-08-06"
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(car)
library(MASS)
library(corrplot)
library(reshape2)
library(faraway)
library(caret)
```

## 1. Import and clean data

```{r}
data <- read.csv("master.csv", header = TRUE)

attach(data)
head(data)
str(data)
dim(data)
```
### Clean data

```{r}
# Rename
data$gdp_for_year <- data$gdp_for_year....
data$gdp_for_year.... <- NULL

data$gdp_per_capita <- data$gdp_per_capita....
data$gdp_per_capita.... <- NULL
```

```{r}
# Check for missing values
missing_values <- sapply(data, function(x) sum(is.na(x)))
print(missing_values)
```
The missing values of HDI.for.year account for about 70% of the dataset. Therefore, we decide to remove this variable. Moreover, country.year is combination string of country and year, which is redundant; and suicides.100k.pop is suicides / (population / 100k), which includes our dependent variable suicides_no, so we also decide to remove those variables at first.

```{r}
data_clean <- data
data_clean <- dplyr::select(data_clean, -HDI.for.year, -country.year, -suicides.100k.pop)
```

```{r}
# Convert gdp_for_year.... to numeric after removing commas
data_clean <- data_clean %>%
mutate(gdp_for_year = as.numeric(gsub(",", "", gdp_for_year)))
str(data_clean)
detach(data)
attach(data_clean)
```

### Descriptive statistic

```{r}
hist(suicides_no, breaks = 50)
log_suicides_no <- log(suicides_no + 1) + 1

hist(log_suicides_no, breaks = 30)

boxplot(log_suicides_no)
```
```{r}
boxplot(year)
hist(year, breaks = 20)
pie(table(year))
```
The number of suicides cases seem to increase over the years. The number of suicides cases is the lowest in 2016, which may be due to lack of data.

```{r}
pie(table(sex))
barplot(table(sex))
```
The suicide cases distributed evenly among male and female.


```{r}
boxplot(log(population))
hist(log(gdp_per_capita)^2, breaks = 50)

boxplot(log(gdp_for_year))
hist(log(gdp_for_year), breaks = 20, main = "Histogram of GDP for Year", xlab = "GDP for Year")

```


```{r}
barplot(table(generation))
pie(table(generation))
barplot(table(age))
pie(table(age))
```
Based on the observation, the suicides cases distributed evenly among different ages. The number of suicides cases is the lowest in the Generation Z group.

```{r}
hist(log(population)^2, breaks = 30)
```


### Preprocess data

```{r}
# Process 'gdp_per_capita' column
data_clean$transform_gdp_per_capita <- log(gdp_per_capita)^2
data_clean$gdp_per_capita <- NULL
```

```{r}
# Process 'population' column
data_clean$transform_population <- log(population)^2
data_clean$population <- NULL
```


```{r}
# Process 'gdp_per_capita' column
data_clean$transform_gdp_for_year <- log(gdp_for_year)
data_clean$gdp_for_year <- NULL
```

```{r}
# Process 'suicides_no' column
data_clean$log_suicides_no <- log(suicides_no + 1) + 1
data_clean$suicides_no <- NULL
```


```{r}
# Process 'year' column
data_clean$year <- data_clean$year - 1985 + 1
```


```{r}
# # Create dummy variables for the 'country' column
# dummy_vars <- model.matrix(~ country, data = data_clean)
# 
# # Remove the intercept column
# dummy_vars <- dummy_vars[, -1]
# 
# # Combine the dummy variables with the original data frame
# data_clean <- cbind(data_clean, dummy_vars)
# 
# data_clean <- dplyr::select(data_clean, -country)
# str(data_clean)
# Define country groups based on continents or regions
data_clean$regionEurope <- ifelse(data_clean$country %in% c("Austria", "Iceland", "Netherlands", "Belgium", "Bulgaria", "France", "Greece", "Ireland", "Italy", "Luxembourg", "Malta", "Norway", "Portugal", "Romania", "Spain", "Sweden", "United Kingdom", "Ukraine", "Finland", "Switzerland", "Serbia", "Slovenia", "Slovakia", "Albania", "Denmark", "Estonia", "Latvia", "Lithuania", "Belarus", "Croatia", "Czech Republic", "Germany", "Hungary", "Poland", "San Marino", "Bosnia and Herzegovina"), 1, 0)

data_clean$regionAsia <- ifelse(data_clean$country %in% c("Israel", "Japan", "Republic of Korea", "Singapore", "Turkmenistan", "Thailand", "Russian Federation", "Kazakhstan", "Kyrgyzstan", "Armenia", "Azerbaijan", "Philippines", "Cyprus", "Qatar", "Sri Lanka", "Maldives", "Turkey", "United Arab Emirates", "Oman", "Bahrain", "Uzbekistan", "Georgia", "Macau"), 1, 0)

data_clean$regionAfrica <- ifelse(data_clean$country %in% c("Mauritius", "South Africa", "Seychelles", "Cabo Verde"), 1, 0)

data_clean$regionNorthAmerica <- ifelse(data_clean$country %in% c("Canada", "Costa Rica", "Guatemala", "Mexico", "Puerto Rico", "United States", "Belize", "Saint Lucia", "Antigua and Barbuda", "Trinidad and Tobago", "Panama", "Saint Vincent and Grenadines", "Cuba", "El Salvador", "Bahamas", "Jamaica", "Saint Kitts and Nevis", "Dominica"), 1, 0)
                             
data_clean$regionSouthAmerica <- ifelse(data_clean$country %in% c("Argentina", "Brazil", "Chile", "Colombia", "Ecuador", "Paraguay", "Suriname", "Uruguay", "Guyana"), 1, 0)
                             
data_clean$regionOceania <- ifelse(data_clean$country %in% c("Australia", "New Zealand", "Fiji", "Kiribati", "Montenegro"), 1, 0)

# Remove the 'country' column after creating 'region'
data_clean$country <- NULL
```

```{r}
data_clean$sexMale <- ifelse(data_clean$sex == "male", 1, 0)
data_clean$sex <- NULL
```

```{r}
data_clean$geneX <- ifelse(data_clean$generation == "Generation X", 1, 0)
data_clean$geneMillenials <- ifelse(data_clean$generation == "Millenials", 1, 0)
data_clean$geneBoomers <- ifelse(data_clean$generation == "Boomers", 1, 0)
data_clean$geneSilent <- ifelse(data_clean$generation == "Silent", 1, 0)
data_clean$generation <- NULL
# The other generation would be G.I. Generation
```

```{r}
data_clean$Age15to24 <- ifelse(data_clean$age == "15-24 years", 1, 0)
data_clean$Age25to34 <- ifelse(data_clean$age == "25-34 years", 1, 0)
data_clean$Age35to54 <- ifelse(data_clean$age == "35-54 years", 1, 0)
data_clean$Age55to74 <- ifelse(data_clean$age == "55-74 years", 1, 0)
data_clean$age <- NULL
#The other generation would be 75+ years
```


```{r}
str(data_clean)
```

## 2. Split data to train and test
```{r}
set.seed(1)
sample_size <- floor(0.8 * nrow(data_clean))
train_indices <- sample(seq_len(nrow(data_clean)), size = sample_size)
data_train <- data_clean[train_indices, ]
data_test <- data_clean[-train_indices, ]
detach(data_clean)
attach(data_train)
```

## 3. Build model

### Check multicollinearity

We consider correlation matrix
```{r}
cor_matrix <- cor(data_train)
cor_matrix
```
heat map:
```{r}
# corrplot(cor_matrix, method = "color", type = "upper", 
#          tl.col = "black", tl.srt = 45, addCoef.col = "black")
# 
# # Convert the correlation matrix to long format for ggplot2
# cor_matrix_melted <- melt(cor_matrix)
# 
# # Visualize with ggplot2
# ggplot(data = cor_matrix_melted, aes(x = Var1, y = Var2, fill = value)) +
#   geom_tile(color = "white") +
#   scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
#                        midpoint = 0, limit = c(-1, 1), space = "Lab", 
#                        name = "Correlation") +
#   theme_minimal() + 
#   theme(axis.text.x = element_text(angle = 45, vjust = 1, 
#                                    size = 12, hjust = 1)) +
#   coord_fixed()
```

```{r}
model = lm(log_suicides_no ~ ., data = data_train)
summary(model)
vif(model)
```

```{r}
model = lm(log_suicides_no ~ . -transform_gdp_for_year , data = data_train)
summary(model)
vif(model)
```
```{r}
model = lm(log_suicides_no ~ . -transform_gdp_for_year -regionEurope, data = data_train)
summary(model)
vif(model)
```

### Variable selection

```{r}
modFull = lm(log_suicides_no ~ . -transform_gdp_for_year -regionEurope, data = data_train)
modZero = lm(log_suicides_no ~ 1, data = data_train)
modInter = lm(log_suicides_no ~ year + transform_population + regionAsia + regionNorthAmerica + sexMale + geneBoomers + Age25to34, data = data_train)
```

```{r}
# model2 = MASS::stepAIC(modInter, direction = "both", scope = list(lower = modZero, upper = modFull), k = 2)
# model3 = MASS::stepAIC(modInter, direction = "both", scope = list(lower = modZero, upper = modFull), k = log(nrow(data_train)))
```

```{r}
modelAIC = MASS::stepAIC(modFull, direction = "backward", scope = list(lower = modZero, upper = modFull), k = 2)
```


```{r}
summary(modelAIC)
```

## 4. Hypothesis testing

### Shapiro-Wilk test for normality

```{r}
# Use Shapiro-Wilk test to test for normality of the residuals
set.seed(123) # For reproducibility
subsample_residuals <- sample(residuals(modelAIC), size = 5000)
shapiro.test(subsample_residuals)
```


```{r}
# Plot residuals to visually check for normality
par(mfrow=c(1,2))

hist_residuals <- residuals(modelAIC)
hist(hist_residuals, main = "Residuals Histogram", xlab = "Residuals", breaks = 30, probability = TRUE)

mean_residuals <- mean(hist_residuals)
sd_residuals <- sd(hist_residuals)
curve(dnorm(x, mean = mean_residuals, sd = sd_residuals), col = "red", add = TRUE)

qqnorm(hist_residuals, main = "Q-Q Plot of Residuals")
qqline(hist_residuals, col = "red")
```

### Studentized Breusch-Pagan test for heteroscedasticity
```{r}
bp_test <- bptest(modelAIC)
print(bp_test)
```

### Box-Cox Transformation
```{r}
boxcox_result <- boxcox(modelAIC, plotit = TRUE)
lambda <- boxcox_result$x
log_likelihood <- boxcox_result$y

# Find the lambda with the maximum log-likelihood
best_lambda <- lambda[which.max(log_likelihood)]

# Print the best lambda
print(best_lambda)
```

```{r}
# Build the final model with Box-Cox transformation
best_lambda = 1.5
model_cox = lm((((data_train$log_suicides_no^best_lambda) - 1)/best_lambda) ~ . -transform_gdp_for_year -regionEurope, data = data_train)
summary(model_cox)
```

```{r}
# Use Shapiro-Wilk test to test for normality of the residuals
set.seed(123) # For reproducibility
subsample_residuals <- sample(residuals(model_cox), size = 5000)
shapiro.test(subsample_residuals)
```


```{r}
# Plot residuals to visually check for normality
par(mfrow=c(1,2))

hist_residuals <- residuals(model_cox)
hist(hist_residuals, main = "Residuals Histogram", xlab = "Residuals", breaks = 30, probability = TRUE)

mean_residuals <- mean(hist_residuals)
sd_residuals <- sd(hist_residuals)
curve(dnorm(x, mean = mean_residuals, sd = sd_residuals), col = "red", add = TRUE)

qqnorm(hist_residuals, main = "Q-Q Plot of Residuals")
qqline(hist_residuals, col = "red")
```

### Studentized Breusch-Pagan test for heteroscedasticity
```{r}
bp_test <- bptest(model_cox)
print(bp_test)
```